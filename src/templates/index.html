<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SALA DE SITUA√á√ÉO | CPRAIO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Tema Claro - Gest√£o Visual */
            --bg-color: #f4f6f8;
            --sidebar-bg: #ffffff;
            --text-main: #2c3e50;
            --border-color: #e1e4e8;
            --accent-red: #d32f2f;
            --accent-blue: #1976d2;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .grid-container {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .header {
            padding-bottom: 15px;
            border-bottom: 2px solid var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 22px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .header span { font-size: 12px; color: #666; font-weight: 600; text-transform: uppercase; }

        .btn-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-block;
            white-space: nowrap;
        }
        .btn-dashboard:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Inputs */
        .control-label { font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase; margin-bottom: 6px; display: block; }
        select {
            width: 100%;
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border 0.2s;
        }
        select:focus { border-color: var(--accent-blue); }

        /* Lista de Alvos */
        .target-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        
        .target-card {
            background: #fff;
            border: 1px solid #eee;
            border-left: 4px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .target-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* Cores de Alerta */
        .target-card.CR√çTICO { border-left-color: #d32f2f; background: #fff5f5; }
        .target-card.ALTO { border-left-color: #f57c00; }
        .target-card.M√âDIO { border-left-color: #fbc02d; }

        .target-name { font-weight: 700; font-size: 15px; display: block; color: #000; }
        .target-meta { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-top: 5px; }

        /* Status */
        .system-status {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        /* --- MAPA --- */
        #map { width: 100%; height: 100%; background: #e0e0e0; }
        
        /* Custom Tooltip */
        .tactical-tooltip {
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
        }

        /* Loading Overlay */
        #loading {
            position: absolute; top: 20px; right: 20px;
            background: #fff; padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: 600; font-size: 13px; color: #333;
            display: none; z-index: 9999;
            display: flex; align-items: center; gap: 10px;
        }
        .spinner {
            width: 12px; height: 12px; border: 2px solid #ccc; border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="grid-container">
    <div class="sidebar">
        <div class="header">
            <div>
                <h1>SIGERAIO</h1>
                <span>Painel de Comando Operacional</span>
            </div>
            <a href="/dashboard-estrategico" class="btn-dashboard" title="Abrir Dashboard Estrat√©gico com an√°lise de IA">
                ü§ñ Dashboard
            </a>
        </div>

        <div>
            <label class="control-label">Regi√£o</label>
            <select id="regionSelect" onchange="refreshData()">
                <option value="CAPITAL">Fortaleza</option>
                <option value="RMF">Regi√£o Metropolitana</option>
                <option value="INTERIOR">Interior</option>
            </select>
        </div>

        <div>
            <label class="control-label">Filtro Territorial (Fac√ß√£o)</label>
            <select id="factionSelect" onchange="refreshData()">
                <option value="TODAS">Todas as Fac√ß√µes</option>
                <option value="CV">Comando Vermelho (CV)</option>
                <option value="TCP">Terceiro Comando Puro (TCP)</option>
                <option value="MASSA">Massa</option>
                <option value="PCC">Primeiro Comando da Capital (PCC)</option>
                <option value="DISPUTA">√Åreas em Disputa</option>
                <option value="GDE">Guardi√µes do Estado (GDE)</option>
                <option value="NEUTRO">Comunidades Neutras</option>
            </select>
        </div>

        <div>
            <label class="control-label">Tipo de Crime</label>
            <select id="crimeTypeSelect" onchange="refreshData()">
                <option value="TODOS">Todos</option>
                <option value="CVP">CVP - Viol√™ncia Patrimonial</option>
                <option value="CVLI">CVLI - Letais e Intencionais</option>
            </select>
        </div>

        <label class="control-label" style="margin-top:10px;">√Åreas Cr√≠ticas (Top 5)</label>
        <div id="targetList" class="target-list">
            </div>

        <div class="system-status">
            ‚óè SISTEMA INTEGRADO
        </div>
    </div>

    <div style="position:relative;">
        <div id="loading"><div class="spinner"></div> Atualizando...</div>
        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // Mapa Light (Positron) - Muito mais limpo
    const map = L.map('map', { zoomControl: false }).setView([-3.79, -38.56], 12);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Dados: CPRAIO/CIOPS',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    let riskLayer = L.geoJSON(null).addTo(map);
    let markers = L.markerClusterGroup({ showCoverageOnHover: false });
    map.addLayer(markers);

    // Cores t√°ticas
    const colors = {
        'CR√çTICO': '#d32f2f', // Vermelho Forte
        'ALTO': '#f57c00',    // Laranja
        'M√âDIO': '#fbc02d',   // Amarelo
        'BAIXO': 'transparent' // INVIS√çVEL
    };

    function styleRisk(feature) {
        let nivel = feature.properties.nivel_alerta;
        let cor = colors[nivel] || 'transparent';
        
        // Se for baixo, nem desenha a borda
        let opacity = (nivel === 'BAIXO' || !nivel) ? 0 : 0.4;
        let stroke = (nivel === 'BAIXO' || !nivel) ? 0 : 1;

        return {
            fillColor: cor,
            weight: stroke,
            opacity: 1,
            color: cor, // Borda da mesma cor do preenchimento
            fillOpacity: opacity
        };
    }

    async function refreshData() {
        document.getElementById('loading').style.display = 'flex';
        const region = document.getElementById('regionSelect').value;
        const faccao = document.getElementById('factionSelect').value;
        const tipoCrime = document.getElementById('crimeTypeSelect').value;

        try {
            const res = await fetch(`/api/dashboard_data?region=${region}&faccao=${faccao}&tipo_crime=${tipoCrime}`);
            const data = await res.json();

            // Constr√≥i descritor de filtros ativos
            let filtros = [];
            if (faccao !== 'TODAS') filtros.push(`Fac√ß√£o: ${faccao}`);
            if (tipoCrime !== 'TODOS') {
                filtros.push(tipoCrime === 'CVP' ? 'Patrimoniais' : 'Letais');
            }
            let descritor = filtros.length > 0 ? ` [${filtros.join(' ‚Ä¢ ')}]` : '';

            // 1. Pol√≠gonos (Risco ou Territ√≥rio)
            riskLayer.clearLayers();
            if (data.polygons) {
                riskLayer.addData(data.polygons);
                riskLayer.setStyle(styleRisk);
                
                riskLayer.eachLayer(layer => {
                    let p = layer.feature.properties;
                    if (p.nivel_alerta && p.nivel_alerta !== 'BAIXO') {
                        let info = `<strong>${p.name || p.bairro}</strong><br>Status: ${p.nivel_alerta}`;
                        if (p.count_tipo_crime !== undefined) {
                            info += `<br>Crimes: ${p.count_tipo_crime}`;
                        }
                        if (p.percentual !== undefined) {
                            info += `<br>Domin√¢ncia: ${p.percentual}%`;
                        }
                        layer.bindTooltip(info, { sticky: true, className: 'tactical-tooltip' });
                    }
                });
            }

            // 2. Pontos (Clusters) - Apenas quando n√£o h√° filtro de fac√ß√£o
            markers.clearLayers();
            if (faccao === 'TODAS' && data.points && data.points.length > 0) {
                data.points.forEach(p => {
                    if (p.latitude && p.longitude) {
                        let m = L.circleMarker([p.latitude, p.longitude], {
                            radius: 5,
                            fillColor: '#333',
                            color: '#fff',
                            weight: 1,
                            fillOpacity: 0.8
                        });
                        m.bindPopup(`<b>${p.natureza}</b><br>Local: ${p.local_oficial}<br>Fac√ß√£o: ${p.faccao}<br>Tipo: ${p.tipo}`);
                        markers.addLayer(m);
                    }
                });
            }

            // 3. Lista Lateral
            updateList(data.targets);
            
            // Auto-Zoom
            if (data.polygons && data.polygons.features.length > 0) {
                map.fitBounds(riskLayer.getBounds());
            }

        } catch (e) {
            console.error(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function updateList(targets) {
        const div = document.getElementById('targetList');
        div.innerHTML = '';
        if (!targets || targets.length === 0) {
            div.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">Nenhum alerta cr√≠tico.</div>';
            return;
        }
        targets.forEach(t => {
            let el = document.createElement('div');
            el.className = `target-card ${t.nivel}`;
            el.innerHTML = `
                <span class="target-name">${t.local}</span>
                <div class="target-meta">
                    <span>${t.nivel}</span>
                    <span>IA: ${t.score.toFixed(2)}</span>
                </div>
            `;
            el.onclick = () => {
                riskLayer.eachLayer(l => {
                    let p = l.feature.properties;
                    if ((p.name || p.bairro) === t.local) {
                        map.fitBounds(l.getBounds());
                        l.openTooltip();
                    }
                });
            };
            div.appendChild(el);
        });
    }

    refreshData();
</script>
</body>
</html>